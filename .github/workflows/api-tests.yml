name: API Automation Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: api-tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  api-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2

      # ✅ Start Petstore inside GitHub runner
      - name: Start Petstore (Docker)
        run: |
          docker pull swaggerapi/petstore3:latest
          docker run -d --name petstore -p 8080:8080 swaggerapi/petstore3:latest
          docker ps

      # ✅ Wait until API is reachable
      - name: Wait for Petstore to be ready
        run: |
          for i in {1..30}; do
            if curl -sSf http://localhost:8080/api/v3/openapi.json > /dev/null; then
              echo "Petstore is up!"
              exit 0
            fi
            echo "Waiting for Petstore..."
            sleep 2
          done
          echo "Petstore did not start in time"
          docker logs petstore || true
          exit 1

      # ✅ Run tests
      # IMPORTANT: use -Denv=local because you already have local.properties
      # If you want to run all tests, set -Dgroups= (empty) or remove -Dgroups
      - name: Run API tests
        run: mvn -e clean test -Denv=local -Dgroups=smoke

      # ✅ Helpful diagnostics if tests fail
      - name: Dump Petstore logs (on failure)
        if: failure()
        run: docker logs petstore || true

      # ✅ Build TestNG summary JSON for PR comment
      - name: Build test summary (TestNG)
        if: always()
        run: |
          python3 - << 'PY'
          import os, xml.etree.ElementTree as ET, json
          path = "target/surefire-reports/testng-results.xml"
          summary = {"total":0,"passed":0,"failed":0,"skipped":0,"failed_tests":[]}
          if os.path.exists(path):
            root = ET.parse(path).getroot()
            summary["total"]   = int(root.attrib.get("total","0"))
            summary["passed"]  = int(root.attrib.get("passed","0"))
            summary["failed"]  = int(root.attrib.get("failed","0"))
            summary["skipped"] = int(root.attrib.get("skipped","0"))
            for m in root.findall(".//test-method"):
              if m.attrib.get("status","").upper() == "FAIL":
                cls = m.attrib.get("class","")
                name = m.attrib.get("name","")
                summary["failed_tests"].append(f"{cls}.{name}" if cls else name)
          else:
            summary["note"] = "No testng-results.xml found."
          os.makedirs("target/ci", exist_ok=True)
          with open("target/ci/test-summary.json","w") as f:
            json.dump(summary,f,indent=2)
          print(summary)
          PY

      # ✅ Upload Allure raw results
      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: target/allure-results

      # ✅ Pull previous history from gh-pages (for trends)
      - name: Pull previous Allure history (gh-pages)
        if: always()
        run: |
          set +e
          git clone --depth 1 --branch gh-pages "https://github.com/${{ github.repository }}.git" gh-pages
          if [ -d "gh-pages/allure-history" ]; then
            mkdir -p target/allure-results/history
            cp -R gh-pages/allure-history/* target/allure-results/history/ || true
          fi
          set -e

      # ✅ Generate Allure HTML report
      - name: Generate Allure HTML report
        if: always()
        run: mvn -q allure:report

      # ✅ Prepare site content for GitHub Pages
      - name: Prepare Pages content (report + history)
        if: always()
        run: |
          rm -rf public
          mkdir -p public
          cp -R target/site/allure-maven-plugin/* public/ || true

          mkdir -p public/allure-history
          if [ -d "public/history" ]; then
            cp -R public/history/* public/allure-history/ || true
          fi

          if [ ! -f "public/index.html" ]; then
            echo "<html><body><h3>Allure report not generated</h3></body></html>" > public/index.html
          fi

      - name: Upload Allure HTML report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: public

      # ✅ Deploy ONLY on push to main
      - name: Deploy Allure report to GitHub Pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: public

      # ✅ Sticky PR comment (only on PRs)
      - name: Comment on PR with test summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = { total: 0, passed: 0, failed: 0, skipped: 0, failed_tests: [] };
            try { summary = JSON.parse(fs.readFileSync('target/ci/test-summary.json', 'utf8')); } catch (e) {}

            const statusEmoji = summary.failed > 0 ? "❌" : "✅";
            const marker = "<!-- api-tests-summary -->";
            const pagesUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/`;

            const lines = [];
            lines.push(`**${statusEmoji} API Tests (TestNG)**`);
            lines.push(`- Total: **${summary.total}** | Passed: **${summary.passed}** | Failed: **${summary.failed}** | Skipped: **${summary.skipped}**`);
            lines.push(`- Commit: \`${context.sha.substring(0,7)}\``);
            lines.push(`- Allure Report (main): ${pagesUrl}`);

            if (summary.failed_tests?.length) {
              const top = summary.failed_tests.slice(0, 8);
              lines.push(`\n**Failed tests (top ${top.length}):**`);
              for (const t of top) lines.push(`- \`${t}\``);
              if (summary.failed_tests.length > top.length) lines.push(`- …and ${summary.failed_tests.length - top.length} more`);
            }

            const body = `${marker}\n${lines.join("\n")}`;

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            const comments = await github.rest.issues.listComments({ owner, repo, issue_number });
            const existing = comments.data.find(c => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }
